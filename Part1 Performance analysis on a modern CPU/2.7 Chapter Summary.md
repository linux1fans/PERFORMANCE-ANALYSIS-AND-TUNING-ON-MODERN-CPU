• 如果编写得当，微基准测试可以是性能数据的良好来源。它们经常用于比较关键功能不同实现的性能。一个好的基准测试的定义在于它是否在将来实际使用的条件下测试性能。如果基准测试使用与实际使用不同的合成输入，那么该基准测试可能会误导您，并导致错误的结论。此外，当基准测试在一个没有其他高负荷进程的系统上运行时，它拥有所有可用的资源，包括DRAM和缓存空间。这样的基准测试很可能会优先考虑功能更快的版本，即使它消耗比其他版本更多的内存。然而，如果有消耗大部分DRAM的相邻进程，这将导致基准测试进程的内存区域被交换到磁盘，结果可能会相反。

• 出于同样的原因，当从单元测试一个函数中得出结果时要小心。现代的单元测试框架[^52]提供了每个测试的持续时间。然而，这些信息不能替代一个精心编写的基准测试，该测试使用实际输入在实际条件下测试函数（详见[Fog, 2004, chapter 16.2]）。虽然不总是可能复制实际使用中的确切输入和环境，但开发人员在编写良好的基准测试时应该考虑到这一点。

## 2.7 章节总结

• 调试性能问题通常比调试功能性错误更难，因为涉及到测量不稳定性问题。

• 除非设定了特定的目标，否则永远不能停止优化。要知道是否达到了期望的目标，您需要提出有意义的定义和衡量标准。根据您关心的内容，这可以是吞吐量、延迟、每秒操作（性能天花板）等。

• 现代系统具有非确定性性能。消除系统中的非确定性对于定义明确、稳定的性能测试（例如微基准测试）非常有帮助。在生产部署中测量性能需要使用统计方法来分析结果，以处理嘈杂的环境。

• 越来越多的大型分布式软件供应商选择在生产系统上直接分析和监视性能，这需要使用轻量级的性能分析技术。

• 使用自动化性能跟踪系统非常有益，可以防止性能退化泄漏到生产软件中。这些持续集成系统应运行自动化性能测试，可视化结果，并标记潜在的缺陷。

• 可视化性能分布可能有助于发现性能异常。这也是向广泛受众呈现性能结果的安全方式。

• 性能分布之间的统计关系可以使用假设检验方法来确定，例如学生t检验。一旦确定差异在统计上是显著的，那么可以将加速比计算为平均值或几何平均值之间的比率。

• 可以放弃冷启动以确保所有内容都处于热运行状态，但不要故意丢弃不需要的数据。如果选择丢弃一些样本数据，应该对所有分布进行统一处理。

• 为了基准执行时间，工程师可以使用所有现代平台提供的两种不同的计时器。系统范围的高分辨率计时器适用于测量持续时间超过一微秒的事件。

[^52]（注：文中提到的链接 "GoogleTest" 是指 Google 的 C++ 测试框架，详情请参考 [GoogleTest](https://github.com/google/googletest)。）
