这项工作表明，通过在运行时有效地和重复地随机化代码、堆栈和堆对象的放置，可以消除由内存布局引起的测量偏差。遗憾的是，这些想法并没有得到进一步的发展，现在这个项目几乎被废弃了。

**个人经验：**请记住，即使运行像Linux top这样的任务管理工具也会影响测量结果，因为会激活某个CPU核心并分配给它。这可能会影响实际基准测试运行的核心频率。

在进行一致的测量时，需要在相同条件下运行所有基准测试的迭代。然而，无法完全复制相同的环境并完全消除偏差：可能存在不同的温度条件、电力供应峰值、运行的相邻进程等。追踪系统中所有潜在的噪音和变异源可能是一个无休止的过程。有时候这是无法实现的，例如在对大型分布式云服务进行基准测试时。

因此，在一个系统中消除非确定性对于明确定义的、稳定的性能测试非常有帮助，例如微基准测试。例如，当您实施某个代码更改并想要通过对同一程序的两个不同版本进行基准测试来了解相对加速比时。在这种情况下，您可以控制基准测试中的大多数变量，包括其输入、环境配置等。在这种情况下，在系统中消除非确定性有助于获得更一致和准确的比较结果。

在完成本地测试后，请确保项目的性能改进在实际测量中得到体现。读者可以在附录A中找到一些可能引入性能测量噪音的功能示例以及如何禁用它们的方法。此外，还有一些工具可以设置环境，以确保基准测试结果的方差较低；其中之一是temci[^24]。

不建议在估计真实世界性能改进时消除系统的非确定性行为。工程师应该尽量复制他们正在进行优化的目标系统配置。对于正在测试的系统引入任何人为的调整都会使结果与实际使用您服务的用户看到的结果不一致。此外，任何性能分析工作，包括剖析（请参阅第5.4节），应该在与实际部署相似的系统上进行。

最后，需要牢记的是，即使特定的硬件或软件特性具有非确定性行为，这并不意味着它是有害的。它可能会产生不一致的结果，但它旨在提高系统的整体性能。禁用这样的特性可能会减少微基准测试中的噪音，但会导致整个基准测试套件运行时间变长。这对于CI/CD性能测试可能尤为重要，因为整个基准测试套件的运行时间可能受到时间的限制。

## 2.2 在生产环境中进行性能测量

当应用程序在共享基础架构上运行（通常在公有云中），通常会有其他客户的工作负载在同一台服务器上运行。随着虚拟化和容器等技术越来越流行，公有云提供商试图充分利用其服务器的容量。不幸的是，这给在这样的环境中进行性能测量带来了额外的障碍。与邻居进程共享资源可能以不可预测的方式影响性能测量。

通过在实验室中重现生产工作负载来进行分析可能会很棘手。有时候，这是不可能的。

[^24]: Temci - https://github.com/parttimenerd/temci
